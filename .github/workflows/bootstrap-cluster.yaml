name: "bootstrap-cluster"
on:
  workflow_dispatch: {}

env:
  TF_IN_AUTOMATION: "true"
  TF_VAR_onepassword_sa_token: ${{ secrets.ONEPASSWORD_SA_TOKEN }}
concurrency:
  group: ${{ github.repository }}
  cancel-in-progress: false

jobs:
  bootstrap-cluster:
    runs-on: "ubuntu-latest"
    permissions:
      contents: "read"
      id-token: "write"

    steps:
      - name: DateAndTimeStamps
        id: stamps
        run: |
          set -euo pipefail
          timestamp=$(date +'%Y%m%dT%H%M%S')
          datestamp=$(date +'%Y%m%d')
          echo "TIMESTAMP=${timestamp}" | tee -a "$GITHUB_OUTPUT"
          echo "DATESTAMP=${datestamp}" | tee -a "$GITHUB_OUTPUT"
      - uses: "actions/checkout@v5"
      - uses: "hashicorp/setup-terraform@v3"
        with:
          terraform_version: "1.13.3"

      - name: Load secrets
        id: load_secrets
        uses: 1password/load-secrets-action@v3
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.ONEPASSWORD_SA_TOKEN }}
          GCP_TILES_TF_SA_EMAIL: "op://tiles-secrets/gcp_tiles_tf_sa/username"
          GCP_TILES_TF_SA_KEY: "op://tiles-secrets/gcp_tiles_tf_sa/password"
          # TILES_VPN_CONFIG: "op://tiles-secrets/github-vpn-config/wireguard-config"
          VPN_PRIVATE_KEY: "op://tiles-secrets/github-vpn-client/private-key"
          VPN_PUBLIC_KEY: "op://tiles-secrets/github-vpn-client/public-key"
          VPN_ENDPOINT: "op://tiles-secrets/github-vpn-client/endpoint"

      - name: Authenticate to Google Cloud
        run: |
          set -euo pipefail
          echo '${{ steps.load_secrets.outputs.GCP_TILES_TF_SA_KEY }}' > "${RUNNER_TEMP}/gcp-sa-key.json"
          echo "GOOGLE_APPLICATION_CREDENTIALS=${RUNNER_TEMP}/gcp-sa-key.json" >> "$GITHUB_ENV"
          echo "GOOGLE_CLOUD_PROJECT=${{ secrets.PROJECT_ID }}" >> "$GITHUB_ENV"

      - name: Terraform cache
        id: tf-cache
        uses: actions/cache@v4
        with:
          path: |
            **/.terraform
          # Use date so we refetch once a day no matter what.
          key: ${{ runner.os }}-tools-${{ steps.stamps.outputs.DATESTAMP }}-${{ hashFiles('**/.terraform.lock.hcl') }}
          restore-keys: |
            ${{ runner.os }}-tools-${{ steps.stamps.outputs.DATESTAMP }}-
            ${{ runner.os }}-tools-

      - name: Terraform init
        if: steps.tf-cache.outputs.cache-hit != 'true'
        run: |
          set -euo pipefail
          cd "${GITHUB_WORKSPACE}/tf/nodes"
          terraform init

      - uses: ./.github/actions/wireguard
        name: Wireguard
        id: wireguard
        with:
          # vpn_config: ${{ steps.load_secrets.outputs.VPN_CONFIG }}
          conf_dir: "${{ runner.temp }}/wg"
          private_key: ${{ steps.load_secrets.outputs.VPN_PRIVATE_KEY }}
          public_key: ${{ steps.load_secrets.outputs.VPN_PUBLIC_KEY }}
          endpoint: ${{ steps.load_secrets.outputs.VPN_ENDPOINT }}
          allowed_ips: 0.0.0.0/0
          client_ip: 10.1.0.4
          gateway_ip: 10.1.0.1

      - name: Bootstrap cluster
        id: bootstrap-cluster
        shell: bash
        run: |
          set -euxo pipefail
          cd "${GITHUB_WORKSPACE}/charts"
          ./install-crds.sh
          ./bootstrap-cluster.sh
