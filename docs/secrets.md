# Secret Management

Secrets are (almost) all stored in a 1Password vault dedicated to this cluster.

## Initial Secrets

Many secrets are generated by the `tf/bootstrap` bundle, which creates service accounts
and restricted tokens where it can. However some are created manually:

* `tiles-onepassword-sa` which is a full 1Password service account with read-write
  access to the relevant vault. Note that this would allow privilege escalation (read becomes write), and
  should probably live in a separate privileged vault.
* `github-vpn-client` with a `notesPlain` with a Wireguard config in it
* `morpheus-terraform` with a `terraform` service account creds for the Unifi
* `proxmox-root` with a `root` service account for the Proxmox cluster
* `github-tiles-tf-bootstrap` with a Github PAT token granting read-write access
  to lots of Github assets on the containing repo.

## Runtime / Github Actions

Github has a single secret, `ONEPASSWORD_SA_TOKEN`, which allows a workflow to call
the 1Password load secrets action, which gives it access to the rest (including a github
PAT).

## Local Terraform `tf/bootstrap`

The `bootstrap` bundle requires two secrets to be injected, and recovers the rest from
the 1Password vault:

```
eval $(op signon)
export TF_VAR_onepassword_sa_token=$(op read op://tiles-secrets/tiles-onepassword-sa/credential)
export TF_VAR_github_token=$(op read op://tiles-secrets/github-tiles-tf-bootstrap/password)
terraform plan
```
